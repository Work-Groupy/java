# =========================
# Etapa 1: Build da aplicação
# =========================
FROM eclipse-temurin:17-jdk-alpine AS build

# Instalações opcionais (úteis caso o wrapper precise de bash / unzip)
RUN apk add --no-cache bash curl

# Define diretório de trabalho
WORKDIR /workspace

# Copia arquivos de definição primeiro para aproveitar cache de dependências
COPY pom.xml ./
COPY .mvn/ .mvn/
COPY mvnw mvnw

# Faz download das dependências (sem compilar código ainda)
RUN ./mvnw -B -q dependency:go-offline

# Copia o restante do código
COPY src/ src/

# Compila e empacota (gera o jar no target/)
RUN ./mvnw -B -DskipTests package

# =========================
# Etapa 2: Runtime
# =========================
FROM eclipse-temurin:17-jre-alpine AS runtime

# Define variáveis de ambiente
ENV JAVA_OPTS="" \
    SPRING_PROFILES_ACTIVE=prod \
    TZ=UTC

# Cria usuário não-root
RUN addgroup -S app && adduser -S app -G app

WORKDIR /app

# Copia o jar gerado da etapa de build
# Ajuste o nome se diferente (verifique target/). Usando padrão artifactId-version.jar ou o jar reempacotado pelo Spring Boot (workgroup-0.0.1-SNAPSHOT.jar)
COPY --from=build /workspace/target/workgroup-0.0.1-SNAPSHOT.jar /app/app.jar

# Exemplo opcional de diretório para logs
RUN mkdir -p /app/logs && chown -R app:app /app

USER app

# Porta exposta (ajuste se a aplicação usar outra)
EXPOSE 8080

# Entrada
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
